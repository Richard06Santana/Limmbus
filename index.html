<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Saída - V 1.5.2</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        /* Estilo Minimalista Geométrico - Dark Mode V 1.5.2 */
        * { box-sizing: border-box; }
        body { 
            background-color: #0a0a0a; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container { 
            background: #121212; 
            padding: 40px; 
            width: 100%;
            max-width: 450px; 
            border: 1px solid #333; 
            box-shadow: 12px 12px 0px #1a1a1a;
        }

        h2 { 
            margin: 0 0 20px 0; 
            border-left: 5px solid #fff; 
            padding-left: 15px; 
            color: #fff; 
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.4rem;
        }

        label { display: block; font-size: 0.85rem; margin-top: 20px; color: #888; }

        input, textarea { 
            width: 100%; padding: 12px; margin-top: 8px; 
            border: 1px solid #333; background: #1a1a1a;
            color: #fff; outline: none;
        }
        input:focus, textarea:focus { border-color: #fff; }

        .row { display: flex; gap: 15px; }
        .row div { flex: 1; }

        button { 
            width: 100%; margin-top: 30px; padding: 15px; 
            background: #fff; color: #000; border: none; 
            font-weight: bold; cursor: pointer; transition: 0.3s;
            text-transform: uppercase;
        }
        button:hover { background: #ccc; }

        .status-msg { margin-top: 15px; font-size: 0.8rem; color: #2ecc71; opacity: 0; transition: 0.5s; height: 20px; text-align: center; }

        .link-tabela {
            margin-top: 20px;
            color: #666;
            text-decoration: none;
            font-size: 0.8rem;
            border-bottom: 1px solid #222;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Controle de Saída</h2>
    <form id="formLimmbus">
        <label>Nome do funcionário</label>
        <input type="text" id="nome" class="tab-input" placeholder="Nome completo" required autofocus>

        <label>Data</label>
        <input type="date" id="data" class="tab-input" required>

        <div class="row">
            <div>
                <label>Entrada</label>
                <input type="time" id="entrada" class="tab-input" required>
            </div>
            <div>
                <label>Saída</label>
                <input type="time" id="saida" class="tab-input" required>
            </div>
        </div>

        <label>Descrição ou Observações</label>
        <textarea id="descricao" class="tab-input" rows="2" placeholder="Escreva os detalhes aqui..."></textarea>

        <button type="submit" id="btnSalvar">Salvar no Firebase</button>
        <div id="msgSucesso" class="status-msg">Sincronizado com a nuvem!</div>
    </form>
</div>

<div onclick="abrirTabela()" class="link-tabela">Acessar log de alterações (Nuvem)</div>

<script>
    // Configuração oficial que você enviou
    const firebaseConfig = {
        apiKey: "AIzaSyA4AFbehMGUY0D0-j5hIjLcalhirQYlCN4",
        authDomain: "projeto-frutiger.firebaseapp.com",
        projectId: "projeto-frutiger",
        storageBucket: "projeto-frutiger.firebasestorage.app",
        messagingSenderId: "574572027554",
        appId: "1:574572027554:web:7946825d87e03781f401fb"
    };

    // Inicializa o Firebase e o Banco Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Navegação com a tecla Enter
    const inputs = document.querySelectorAll('.tab-input');
    inputs.forEach((input, index) => {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const nextInput = inputs[index + 1];
                if (nextInput) {
                    nextInput.focus();
                } else {
                    document.getElementById('btnSalvar').click();
                }
            }
        });
    });

    // Funções de Cálculo
    function calcularDiferenca(inicio, fim) {
        const [h1, m1] = inicio.split(':').map(Number);
        const [h2, m2] = fim.split(':').map(Number);
        let diffMs = (h2 * 60 + m2) - (h1 * 60 + m1);
        if (diffMs < 0) diffMs += 1440;
        return Math.floor(diffMs / 60) + "h " + (diffMs % 60) + "m";
    }

    function calcularAteMeta(saida) {
        const [hS, mS] = saida.split(':').map(Number);
        const metaMinutos = (17 * 60) + 30;
        const saidaMinutos = (hS * 60) + mS;
        const diff = metaMinutos - saidaMinutos;
        if (diff > 0) return "Faltavam " + Math.floor(diff / 60) + "h " + (diff % 60) + "m";
        if (diff < 0) return "Extra de " + Math.floor(Math.abs(diff) / 60) + "h " + (Math.abs(diff) % 60) + "m";
        return "No horário (17:30)";
    }

    // Salvar no Banco de Dados (Firestore)
    document.getElementById('formLimmbus').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const dados = {
            nome: document.getElementById('nome').value,
            data: document.getElementById('data').value,
            entrada: document.getElementById('entrada').value,
            saida: document.getElementById('saida').value,
            total: calcularDiferenca(document.getElementById('entrada').value, document.getElementById('saida').value),
            meta: calcularAteMeta(document.getElementById('saida').value),
            obs: document.getElementById('descricao').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            // Usa a coleção que você criou: registros_saida
            await db.collection("registros_saida").add(dados);
            
            document.getElementById('msgSucesso').style.opacity = '1';
            setTimeout(() => { document.getElementById('msgSucesso').style.opacity = '0'; }, 2000);
            
            this.reset();
            inputs[0].focus();
        } catch (error) {
            console.error("Erro ao salvar:", error);
            alert("Erro ao salvar no banco! Verifique as regras de segurança.");
        }
    });

    // Abrir Tabela buscando dados da Nuvem
    async function abrirTabela() {
        try {
            const snapshot = await db.collection("registros_saida").orderBy("timestamp", "desc").get();
            const novaAba = window.open("", "_blank");
            
            let linhasHtml = "";
            snapshot.forEach(doc => {
                const item = doc.data();
                linhasHtml += `
                    <tr style="border-bottom:1px solid #222;">
                        <td style="padding:12px;">${item.nome}</td>
                        <td style="padding:12px;">${item.data}</td>
                        <td style="padding:12px;">${item.entrada}</td>
                        <td style="padding:12px;">${item.saida}</td>
                        <td style="padding:12px; font-weight:bold;">${item.total}</td>
                        <td style="padding:12px; color:#aaa;">${item.meta}</td>
                        <td style="padding:12px;">${item.obs || ""}</td>
                    </tr>`;
            });

            novaAba.document.write(`
                <html>
                <head><title>Log de Alterações - Cloud</title></head>
                <body style="background:#0a0a0a; color:#fff; font-family:sans-serif; padding:50px; margin:0;">
                    <h1 style="font-weight:300; border-bottom:2px solid #fff; padding-bottom:10px; text-transform:uppercase;">Log Global (Firebase)</h1>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead style="background:#1a1a1a; text-align:left;">
                            <tr>
                                <th style="padding:15px;">Funcionário</th><th style="padding:15px;">Data</th><th style="padding:15px;">E</th>
                                <th style="padding:15px;">S</th><th style="padding:15px;">Total</th><th style="padding:15px;">Saldo</th>
                                <th style="padding:15px;">Obs</th>
                            </tr>
                        </thead>
                        <tbody>${linhasHtml}</tbody>
                    </table>
                    <p style="color:#444; margin-top:30px;">V 1.5.2 - Dados sincronizados via projeto-frutiger</p>
                </body>
                </html>
            `);
        } catch (e) {
            alert("Erro ao carregar log: " + e.message);
        }
    }
</script>

</body>
</html>
